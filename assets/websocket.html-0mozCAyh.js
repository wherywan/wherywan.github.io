import{_ as p}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as t,o,c as i,a as s,b as a,d as e,e as l}from"./app-hoN0JGLf.js";const r={},c=s("h1",{id:"websocket",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#websocket"},[s("span",null,"websocket")])],-1),d=s("h2",{id:"web客户端样例",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#web客户端样例"},[s("span",null,"web客户端样例")])],-1),v={href:"https://www.cnblogs.com/zqdf/p/15882562.html",target:"_blank",rel:"noopener noreferrer"},y=l(`<div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="shiki light-plus" style="background-color:#FFFFFF;color:#000000;" tabindex="0"><code><span class="line"><span style="color:#800000;">&lt;!DOCTYPE</span><span style="color:#E50000;"> html</span><span style="color:#800000;">&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;html</span><span style="color:#E50000;"> lang</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;en&quot;</span><span style="color:#E50000;"> xmlns:th</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;http://www.thymeleaf.org&quot;</span><span style="color:#800000;">&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;head&gt;</span></span>
<span class="line"><span style="color:#800000;">    &lt;meta</span><span style="color:#E50000;"> http-equiv</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;X-UA-Compatible&quot;</span><span style="color:#E50000;"> content</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;IE=edge,chrome=1&quot;</span><span style="color:#800000;">&gt;</span></span>
<span class="line"><span style="color:#800000;">    &lt;meta</span><span style="color:#E50000;"> name</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;viewport&quot;</span><span style="color:#E50000;"> content</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;</span><span style="color:#800000;">&gt;</span></span>
<span class="line"><span style="color:#800000;">    &lt;meta</span><span style="color:#E50000;"> charset</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;utf-8&quot;</span><span style="color:#800000;">/&gt;</span></span>
<span class="line"><span style="color:#800000;">    &lt;title&gt;</span><span style="color:#000000;">首页</span><span style="color:#800000;">&lt;/title&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;/head&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;body&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;input</span><span style="color:#E50000;"> type</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;button&quot;</span><span style="color:#E50000;"> value</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;发送&quot;</span><span style="color:#E50000;"> onclick</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;</span><span style="color:#795E26;">send</span><span style="color:#0000FF;">()&quot;</span><span style="color:#800000;">&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;div</span><span style="color:#E50000;"> id</span><span style="color:#000000;">=</span><span style="color:#0000FF;">&quot;title&quot;</span><span style="color:#800000;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#800000;">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#008000;">&lt;!-- js部分 --&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;script</span><span style="color:#E50000;"> type</span><span style="color:#000000FF;">=</span><span style="color:#0000FF;">&quot;text/javascript&quot;</span><span style="color:#E50000;"> th:src</span><span style="color:#000000FF;">=</span><span style="color:#0000FF;">&quot;@{/jquery-3.2.1.min.js}&quot;</span><span style="color:#800000;">&gt;&lt;/script&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;script&gt;</span></span>
<span class="line"><span style="color:#0000FF;">    var</span><span style="color:#001080;"> ws</span><span style="color:#000000FF;">;</span></span>
<span class="line"><span style="color:#795E26;">    openWebSocket</span><span style="color:#000000FF;">();</span></span>
<span class="line"><span style="color:#0000FF;">    function</span><span style="color:#795E26;"> openWebSocket</span><span style="color:#000000FF;">(){</span></span>
<span class="line"><span style="color:#AF00DB;">        if</span><span style="color:#000000FF;"> (</span><span style="color:#A31515;">&quot;WebSocket&quot;</span><span style="color:#0000FF;"> in</span><span style="color:#001080;"> window</span><span style="color:#000000FF;">) {</span></span>
<span class="line"><span style="color:#008000;">            //如果已经有连接，则断开并重新连接</span></span>
<span class="line"><span style="color:#AF00DB;">            if</span><span style="color:#000000FF;"> (</span><span style="color:#001080;">ws</span><span style="color:#000000;"> !=</span><span style="color:#0000FF;"> null</span><span style="color:#000000FF;">) {</span></span>
<span class="line"><span style="color:#001080;">                ws</span><span style="color:#000000FF;">.</span><span style="color:#795E26;">close</span><span style="color:#000000FF;">();</span></span>
<span class="line"><span style="color:#001080;">                ws</span><span style="color:#000000;"> =</span><span style="color:#0000FF;"> null</span><span style="color:#000000FF;">;</span></span>
<span class="line"><span style="color:#000000FF;">            }</span></span>
<span class="line"><span style="color:#008000;">            // 创建一个 websocket</span></span>
<span class="line"><span style="color:#0000FF;">　　　　　　　var</span><span style="color:#0070C1;"> UUID</span><span style="color:#000000;"> =</span><span style="color:#098658;"> 123</span><span style="color:#000000FF;">;</span></span>
<span class="line"><span style="color:#001080;">            ws</span><span style="color:#000000;"> =</span><span style="color:#0000FF;"> new</span><span style="color:#795E26;"> WebSocket</span><span style="color:#000000FF;">(</span><span style="color:#A31515;">&quot;ws://localhost:8080/websocket/&quot;</span><span style="color:#000000;">+</span><span style="color:#0070C1;">UUID</span><span style="color:#000000FF;">);</span></span>
<span class="line"><span style="color:#001080;">            ws</span><span style="color:#000000FF;">.</span><span style="color:#795E26;">onopen</span><span style="color:#000000;"> =</span><span style="color:#0000FF;"> function</span><span style="color:#000000FF;"> () {</span></span>
<span class="line"><span style="color:#001080;">                console</span><span style="color:#000000FF;">.</span><span style="color:#795E26;">log</span><span style="color:#000000FF;">(</span><span style="color:#A31515;">&#39;WebSocket连接已建立&#39;</span><span style="color:#000000FF;">)</span></span>
<span class="line"><span style="color:#000000FF;">            };</span></span>
<span class="line"><span style="color:#008000;">            //获得消息事件</span></span>
<span class="line"><span style="color:#001080;">            ws</span><span style="color:#000000FF;">.</span><span style="color:#795E26;">onmessage</span><span style="color:#000000;"> =</span><span style="color:#0000FF;"> function</span><span style="color:#000000FF;"> (</span><span style="color:#001080;">evt</span><span style="color:#000000FF;">) {</span></span>
<span class="line"><span style="color:#795E26;">                $</span><span style="color:#000000FF;">(</span><span style="color:#A31515;">&quot;#title&quot;</span><span style="color:#000000FF;">).</span><span style="color:#795E26;">html</span><span style="color:#000000FF;">(</span><span style="color:#A31515;">&#39;&lt;p&gt;接收：&#39;</span><span style="color:#000000;">+</span><span style="color:#001080;">evt</span><span style="color:#000000FF;">.</span><span style="color:#001080;">data</span><span style="color:#000000;">+</span><span style="color:#A31515;">&#39;&lt;/p&gt;&#39;</span><span style="color:#000000FF;">);</span></span>
<span class="line"><span style="color:#000000FF;">            };</span></span>
<span class="line"><span style="color:#001080;">            ws</span><span style="color:#000000FF;">.</span><span style="color:#795E26;">onclose</span><span style="color:#000000;"> =</span><span style="color:#0000FF;"> function</span><span style="color:#000000FF;"> () {</span></span>
<span class="line"><span style="color:#001080;">                console</span><span style="color:#000000FF;">.</span><span style="color:#795E26;">log</span><span style="color:#000000FF;">(</span><span style="color:#A31515;">&#39;WebSocket连接已断开&#39;</span><span style="color:#000000FF;">)</span></span>
<span class="line"><span style="color:#000000FF;">            };</span></span>
<span class="line"><span style="color:#000000FF;">        } </span><span style="color:#AF00DB;">else</span><span style="color:#000000FF;"> {</span></span>
<span class="line"><span style="color:#008000;">            // 浏览器不支持 WebSocket</span></span>
<span class="line"><span style="color:#001080;">            console</span><span style="color:#000000FF;">.</span><span style="color:#795E26;">log</span><span style="color:#000000FF;">(</span><span style="color:#A31515;">&#39;您的浏览器不支持 WebSocket!&#39;</span><span style="color:#000000FF;">);</span></span>
<span class="line"><span style="color:#000000FF;">        }</span></span>
<span class="line"><span style="color:#000000FF;">    }</span></span>
<span class="line"><span style="color:#0000FF;">function</span><span style="color:#795E26;"> send</span><span style="color:#000000FF;">(){</span></span>
<span class="line"><span style="color:#001080;">        ws</span><span style="color:#000000FF;">.</span><span style="color:#795E26;">send</span><span style="color:#000000FF;">(</span><span style="color:#A31515;">&quot;发送一条消息&quot;</span><span style="color:#000000FF;">);</span></span>
<span class="line"><span style="color:#000000FF;">    }</span><span style="color:#800000;">&lt;/script&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;/body&gt;</span></span>
<span class="line"><span style="color:#800000;">&lt;/html&gt;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="如何携带附加信息进行验证" tabindex="-1"><a class="header-anchor" href="#如何携带附加信息进行验证"><span>如何携带附加信息进行验证？</span></a></h2>`,2),u={href:"https://blog.csdn.net/axiaobaoa/article/details/128548841?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-2-128548841-blog-126894586.235%5Ev27%5Epc_relevant_multi_platform_whitelistv3&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EYuanLiJiHua%7EPosition-2-128548841-blog-126894586.235%5Ev27%5Epc_relevant_multi_platform_whitelistv3&utm_relevant_index=5",target:"_blank",rel:"noopener noreferrer"},F={href:"https://blog.csdn.net/weixin_44330810/article/details/126894586?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-5-126894586-blog-125480587.235%5Ev27%5Epc_relevant_multi_platform_whitelistv3&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-5-126894586-blog-125480587.235%5Ev27%5Epc_relevant_multi_platform_whitelistv3&utm_relevant_index=10",target:"_blank",rel:"noopener noreferrer"},m=l(`<p>1、通过子协议，传入token等信息，后端使用request.getHeaders.get(&quot;Set-WebSocket-protocol&quot;)方式获取信息</p><p>在使用http握手时，响应必须带上上述请求头，否则握手失败</p><p>2、通过在路径中携带附加信息，使用@PathParam从路径中获取信息进行校验</p><h2 id="serverendpoint" tabindex="-1"><a class="header-anchor" href="#serverendpoint"><span>@ServerEndpoint</span></a></h2><h2 id="serverendpointexporter" tabindex="-1"><a class="header-anchor" href="#serverendpointexporter"><span>ServerEndpointExporter</span></a></h2><h3 id="registerendpoint方法" tabindex="-1"><a class="header-anchor" href="#registerendpoint方法"><span>registerEndpoint方法</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki light-plus" style="background-color:#FFFFFF;color:#000000;" tabindex="0"><code><span class="line"><span>//找到ServerEndpoint注解的bean</span></span>
<span class="line"><span>String[] endpointBeanNames = context.getBeanNamesForAnnotation(ServerEndpoint.class);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>for (Class&lt;?&gt; endpointClass : endpointClasses) {</span></span>
<span class="line"><span>			registerEndpoint(endpointClass);</span></span>
<span class="line"><span>		}</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="getservercontainer-initservletcontext" tabindex="-1"><a class="header-anchor" href="#getservercontainer-initservletcontext"><span>getServerContainer,initServletContext</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki light-plus" style="background-color:#FFFFFF;color:#000000;" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>@Nullable</span></span>
<span class="line"><span>	protected ServerContainer getServerContainer() {</span></span>
<span class="line"><span>		return this.serverContainer;</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span>	protected void initServletContext(ServletContext servletContext) {</span></span>
<span class="line"><span>		if (this.serverContainer == null) {</span></span>
<span class="line"><span>			this.serverContainer =</span></span>
<span class="line"><span>					(ServerContainer) servletContext.getAttribute(&quot;javax.websocket.server.ServerContainer&quot;);</span></span>
<span class="line"><span>		}</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="wsservercontainer-servercontainer" tabindex="-1"><a class="header-anchor" href="#wsservercontainer-servercontainer"><span>WsServerContainer,ServerContainer</span></a></h2><p>从上下文ServletContext获取serverContainer</p><p>serverContainer.addEndpoint(endpointClass);</p><p>实例化时添加过滤器WsFilter处理websocket连接</p><h3 id="addendpoint" tabindex="-1"><a class="header-anchor" href="#addendpoint"><span>addEndpoint</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki light-plus" style="background-color:#FFFFFF;color:#000000;" tabindex="0"><code><span class="line"><span> ServerEndpoint annotation = pojo.getAnnotation(ServerEndpoint.class);</span></span>
<span class="line"><span>    if (annotation == null) {</span></span>
<span class="line"><span>        throw new DeploymentException(</span></span>
<span class="line"><span>                sm.getString(&quot;serverContainer.missingAnnotation&quot;,</span></span>
<span class="line"><span>                        pojo.getName()));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    String path = annotation.value();</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="addendpoint-serverendpointconfig-sec-boolean-fromannotatedpojo" tabindex="-1"><a class="header-anchor" href="#addendpoint-serverendpointconfig-sec-boolean-fromannotatedpojo"><span>addEndpoint(ServerEndpointConfig sec, boolean fromAnnotatedPojo)</span></a></h3><ul><li>路径path</li><li>PojoMethodMapping方法映射，getOnOpen，getOnClose</li><li>路径参数</li><li>configTemplateMatchMap</li><li>templateMatches</li></ul><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki light-plus" style="background-color:#FFFFFF;color:#000000;" tabindex="0"><code><span class="line"><span>String path = sec.getPath();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PojoMethodMapping methodMapping = new PojoMethodMapping(sec.getEndpointClass(),</span></span>
<span class="line"><span>                    sec.getDecoders(), path, getInstanceManager(Thread.currentThread().getContextClassLoader()));</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>UriTemplate uriTemplate = new UriTemplate(path);</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>TemplatePathMatch newMatch = new TemplatePathMatch(sec, uriTemplate, fromAnnotatedPojo);</span></span>
<span class="line"><span>TemplatePathMatch oldMatch = templateMatches.putIfAbsent(uriTemplate.getNormalizedPath(), newMatch);</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="configurator" tabindex="-1"><a class="header-anchor" href="#configurator"><span>configurator</span></a></h2><p>ServerEndpoint注解中配置的配置器</p><h2 id="serverendpointconfig" tabindex="-1"><a class="header-anchor" href="#serverendpointconfig"><span>ServerEndpointConfig</span></a></h2><ul><li>Configurator</li><li>Builder 使用ServerEndpointConfig.builder构建端点配置</li></ul><h2 id="nioendpoint下的socketprocessor" tabindex="-1"><a class="header-anchor" href="#nioendpoint下的socketprocessor"><span>NioEndpoint下的SocketProcessor</span></a></h2><p>协议升级请求</p><h2 id="abstractprotocol下的connecthandler的process方法" tabindex="-1"><a class="header-anchor" href="#abstractprotocol下的connecthandler的process方法"><span>AbstractProtocol下的ConnectHandler的process方法</span></a></h2><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki light-plus" style="background-color:#FFFFFF;color:#000000;" tabindex="0"><code><span class="line"><span> HttpUpgradeHandler httpUpgradeHandler = upgradeToken.getHttpUpgradeHandler();</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>// Release the Http11 processor to be re-used</span></span>
<span class="line"><span>release(processor);</span></span>
<span class="line"><span>// Create the upgrade processor</span></span>
<span class="line"><span>processor = getProtocol().createUpgradeProcessor(wrapper, upgradeToken);</span></span>
<span class="line"><span></span></span>
<span class="line"><span> if (upgradeToken.getInstanceManager() == null) {</span></span>
<span class="line"><span>    httpUpgradeHandler.init((WebConnection) processor);</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    ClassLoader oldCL = upgradeToken.getContextBind().bind(false, null);</span></span>
<span class="line"><span>    try {</span></span>
<span class="line"><span>        //!!!!</span></span>
<span class="line"><span>        httpUpgradeHandler.init((WebConnection) processor);</span></span>
<span class="line"><span>    } finally {</span></span>
<span class="line"><span>        upgradeToken.getContextBind().unbind(false, oldCL);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="wshttpupgradehandler" tabindex="-1"><a class="header-anchor" href="#wshttpupgradehandler"><span>WsHttpUpgradeHandler</span></a></h2><h3 id="init方法、" tabindex="-1"><a class="header-anchor" href="#init方法、"><span>init方法、</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki light-plus" style="background-color:#FFFFFF;color:#000000;" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>wsRemoteEndpointServer = new WsRemoteEndpointImplServer(socketWrapper, upgradeInfo, webSocketContainer);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>wsSession = new WsSession(wsRemoteEndpointServer,</span></span>
<span class="line"><span>        webSocketContainer, handshakeRequest.getRequestURI(),</span></span>
<span class="line"><span>        handshakeRequest.getParameterMap(),</span></span>
<span class="line"><span>        handshakeRequest.getQueryString(),</span></span>
<span class="line"><span>        handshakeRequest.getUserPrincipal(), httpSessionId,</span></span>
<span class="line"><span>        negotiatedExtensions, subProtocol, pathParameters, secure,</span></span>
<span class="line"><span>        serverEndpointConfig);</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        ep = wsSession.getLocal();</span></span>
<span class="line"><span>        wsFrame = new WsFrameServer(socketWrapper, upgradeInfo, wsSession, transformation,</span></span>
<span class="line"><span>                applicationClassLoader);</span></span>
<span class="line"><span>        // WsFrame adds the necessary final transformations. Copy the</span></span>
<span class="line"><span>        // completed transformation chain to the remote end point.</span></span>
<span class="line"><span>        wsRemoteEndpointServer.setTransformation(wsFrame.getTransformation());</span></span>
<span class="line"><span>        ep.onOpen(wsSession, serverEndpointConfig);</span></span>
<span class="line"><span>        webSocketContainer.registerSession(serverEndpointConfig.getPath(), wsSession);</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="wsfilter" tabindex="-1"><a class="header-anchor" href="#wsfilter"><span>wsFilter</span></a></h2><p>实例化时添加过滤器WsFilter处理websocket连接</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki light-plus" style="background-color:#FFFFFF;color:#000000;" tabindex="0"><code><span class="line"><span>//发起改变socket请求状态的action的操作</span></span>
<span class="line"><span> UpgradeUtil.doUpgrade(sc, req, resp, mappingResult.getConfig(),</span></span>
<span class="line"><span>                mappingResult.getPathParams());</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="websockethttprequesthandler" tabindex="-1"><a class="header-anchor" href="#websockethttprequesthandler"><span>WebSocketHttpRequestHandler</span></a></h2>`,33);function b(h,g){const n=t("ExternalLinkIcon");return o(),i("div",null,[c,d,s("p",null,[s("a",v,[a("参考"),e(n)])]),y,s("p",null,[s("a",u,[a("参考"),e(n)])]),s("p",null,[s("a",F,[a("参考"),e(n)])]),m])}const k=p(r,[["render",b],["__file","websocket.html.vue"]]),f=JSON.parse(`{"path":"/note/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/websocket.html","title":"websocket","lang":"zh-CN","frontmatter":{"description":"websocket web客户端样例 参考 如何携带附加信息进行验证？ 参考 参考 1、通过子协议，传入token等信息，后端使用request.getHeaders.get(\\"Set-WebSocket-protocol\\")方式获取信息 在使用http握手时，响应必须带上上述请求头，否则握手失败 2、通过在路径中携带附加信息，使用@PathParam...","head":[["meta",{"property":"og:url","content":"https://wherywan.github.io/note/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/websocket.html"}],["meta",{"property":"og:site_name","content":"HONG_JI"}],["meta",{"property":"og:title","content":"websocket"}],["meta",{"property":"og:description","content":"websocket web客户端样例 参考 如何携带附加信息进行验证？ 参考 参考 1、通过子协议，传入token等信息，后端使用request.getHeaders.get(\\"Set-WebSocket-protocol\\")方式获取信息 在使用http握手时，响应必须带上上述请求头，否则握手失败 2、通过在路径中携带附加信息，使用@PathParam..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-03-26T14:16:06.000Z"}],["meta",{"property":"article:author","content":"wanhongji"}],["meta",{"property":"article:modified_time","content":"2023-03-26T14:16:06.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"websocket\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-03-26T14:16:06.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"wanhongji\\"}]}"]]},"headers":[{"level":2,"title":"web客户端样例","slug":"web客户端样例","link":"#web客户端样例","children":[]},{"level":2,"title":"如何携带附加信息进行验证？","slug":"如何携带附加信息进行验证","link":"#如何携带附加信息进行验证","children":[]},{"level":2,"title":"@ServerEndpoint","slug":"serverendpoint","link":"#serverendpoint","children":[]},{"level":2,"title":"ServerEndpointExporter","slug":"serverendpointexporter","link":"#serverendpointexporter","children":[{"level":3,"title":"registerEndpoint方法","slug":"registerendpoint方法","link":"#registerendpoint方法","children":[]},{"level":3,"title":"getServerContainer,initServletContext","slug":"getservercontainer-initservletcontext","link":"#getservercontainer-initservletcontext","children":[]}]},{"level":2,"title":"WsServerContainer,ServerContainer","slug":"wsservercontainer-servercontainer","link":"#wsservercontainer-servercontainer","children":[{"level":3,"title":"addEndpoint","slug":"addendpoint","link":"#addendpoint","children":[]},{"level":3,"title":"addEndpoint(ServerEndpointConfig sec, boolean fromAnnotatedPojo)","slug":"addendpoint-serverendpointconfig-sec-boolean-fromannotatedpojo","link":"#addendpoint-serverendpointconfig-sec-boolean-fromannotatedpojo","children":[]}]},{"level":2,"title":"configurator","slug":"configurator","link":"#configurator","children":[]},{"level":2,"title":"ServerEndpointConfig","slug":"serverendpointconfig","link":"#serverendpointconfig","children":[]},{"level":2,"title":"NioEndpoint下的SocketProcessor","slug":"nioendpoint下的socketprocessor","link":"#nioendpoint下的socketprocessor","children":[]},{"level":2,"title":"AbstractProtocol下的ConnectHandler的process方法","slug":"abstractprotocol下的connecthandler的process方法","link":"#abstractprotocol下的connecthandler的process方法","children":[]},{"level":2,"title":"WsHttpUpgradeHandler","slug":"wshttpupgradehandler","link":"#wshttpupgradehandler","children":[{"level":3,"title":"init方法、","slug":"init方法、","link":"#init方法、","children":[]}]},{"level":2,"title":"wsFilter","slug":"wsfilter","link":"#wsfilter","children":[]},{"level":2,"title":"WebSocketHttpRequestHandler","slug":"websockethttprequesthandler","link":"#websockethttprequesthandler","children":[]}],"git":{"createdTime":1679686314000,"updatedTime":1679840166000,"contributors":[{"name":"wanhongji","email":"wherywan@163.com","commits":2}]},"readingTime":{"minutes":2.3,"words":691},"filePathRelative":"note/网络通信/websocket.md","localizedDate":"2023年3月24日","excerpt":"\\n<h2>web客户端样例</h2>\\n<p><a href=\\"https://www.cnblogs.com/zqdf/p/15882562.html\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">参考</a></p>\\n<div class=\\"language-html line-numbers-mode\\" data-ext=\\"html\\" data-title=\\"html\\"><pre class=\\"shiki light-plus\\" style=\\"background-color:#FFFFFF;color:#000000\\" tabindex=\\"0\\"><code><span class=\\"line\\"><span style=\\"color:#800000\\">&lt;!DOCTYPE</span><span style=\\"color:#E50000\\"> html</span><span style=\\"color:#800000\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;html</span><span style=\\"color:#E50000\\"> lang</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"en\\"</span><span style=\\"color:#E50000\\"> xmlns:th</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"http://www.thymeleaf.org\\"</span><span style=\\"color:#800000\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;head&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">    &lt;meta</span><span style=\\"color:#E50000\\"> http-equiv</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"X-UA-Compatible\\"</span><span style=\\"color:#E50000\\"> content</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"IE=edge,chrome=1\\"</span><span style=\\"color:#800000\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">    &lt;meta</span><span style=\\"color:#E50000\\"> name</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"viewport\\"</span><span style=\\"color:#E50000\\"> content</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"width=device-width, initial-scale=1, maximum-scale=1\\"</span><span style=\\"color:#800000\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">    &lt;meta</span><span style=\\"color:#E50000\\"> charset</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"utf-8\\"</span><span style=\\"color:#800000\\">/&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">    &lt;title&gt;</span><span style=\\"color:#000000\\">首页</span><span style=\\"color:#800000\\">&lt;/title&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;/head&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;body&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;input</span><span style=\\"color:#E50000\\"> type</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"button\\"</span><span style=\\"color:#E50000\\"> value</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"发送\\"</span><span style=\\"color:#E50000\\"> onclick</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"</span><span style=\\"color:#795E26\\">send</span><span style=\\"color:#0000FF\\">()\\"</span><span style=\\"color:#800000\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;div</span><span style=\\"color:#E50000\\"> id</span><span style=\\"color:#000000\\">=</span><span style=\\"color:#0000FF\\">\\"title\\"</span><span style=\\"color:#800000\\">&gt;</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;/div&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#008000\\">&lt;!-- js部分 --&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;script</span><span style=\\"color:#E50000\\"> type</span><span style=\\"color:#000000FF\\">=</span><span style=\\"color:#0000FF\\">\\"text/javascript\\"</span><span style=\\"color:#E50000\\"> th:src</span><span style=\\"color:#000000FF\\">=</span><span style=\\"color:#0000FF\\">\\"@{/jquery-3.2.1.min.js}\\"</span><span style=\\"color:#800000\\">&gt;&lt;/script&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;script&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#0000FF\\">    var</span><span style=\\"color:#001080\\"> ws</span><span style=\\"color:#000000FF\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#795E26\\">    openWebSocket</span><span style=\\"color:#000000FF\\">();</span></span>\\n<span class=\\"line\\"><span style=\\"color:#0000FF\\">    function</span><span style=\\"color:#795E26\\"> openWebSocket</span><span style=\\"color:#000000FF\\">(){</span></span>\\n<span class=\\"line\\"><span style=\\"color:#AF00DB\\">        if</span><span style=\\"color:#000000FF\\"> (</span><span style=\\"color:#A31515\\">\\"WebSocket\\"</span><span style=\\"color:#0000FF\\"> in</span><span style=\\"color:#001080\\"> window</span><span style=\\"color:#000000FF\\">) {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#008000\\">            //如果已经有连接，则断开并重新连接</span></span>\\n<span class=\\"line\\"><span style=\\"color:#AF00DB\\">            if</span><span style=\\"color:#000000FF\\"> (</span><span style=\\"color:#001080\\">ws</span><span style=\\"color:#000000\\"> !=</span><span style=\\"color:#0000FF\\"> null</span><span style=\\"color:#000000FF\\">) {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">                ws</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#795E26\\">close</span><span style=\\"color:#000000FF\\">();</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">                ws</span><span style=\\"color:#000000\\"> =</span><span style=\\"color:#0000FF\\"> null</span><span style=\\"color:#000000FF\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#000000FF\\">            }</span></span>\\n<span class=\\"line\\"><span style=\\"color:#008000\\">            // 创建一个 websocket</span></span>\\n<span class=\\"line\\"><span style=\\"color:#0000FF\\">　　　　　　　var</span><span style=\\"color:#0070C1\\"> UUID</span><span style=\\"color:#000000\\"> =</span><span style=\\"color:#098658\\"> 123</span><span style=\\"color:#000000FF\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">            ws</span><span style=\\"color:#000000\\"> =</span><span style=\\"color:#0000FF\\"> new</span><span style=\\"color:#795E26\\"> WebSocket</span><span style=\\"color:#000000FF\\">(</span><span style=\\"color:#A31515\\">\\"ws://localhost:8080/websocket/\\"</span><span style=\\"color:#000000\\">+</span><span style=\\"color:#0070C1\\">UUID</span><span style=\\"color:#000000FF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">            ws</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#795E26\\">onopen</span><span style=\\"color:#000000\\"> =</span><span style=\\"color:#0000FF\\"> function</span><span style=\\"color:#000000FF\\"> () {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">                console</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#795E26\\">log</span><span style=\\"color:#000000FF\\">(</span><span style=\\"color:#A31515\\">'WebSocket连接已建立'</span><span style=\\"color:#000000FF\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"color:#000000FF\\">            };</span></span>\\n<span class=\\"line\\"><span style=\\"color:#008000\\">            //获得消息事件</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">            ws</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#795E26\\">onmessage</span><span style=\\"color:#000000\\"> =</span><span style=\\"color:#0000FF\\"> function</span><span style=\\"color:#000000FF\\"> (</span><span style=\\"color:#001080\\">evt</span><span style=\\"color:#000000FF\\">) {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#795E26\\">                $</span><span style=\\"color:#000000FF\\">(</span><span style=\\"color:#A31515\\">\\"#title\\"</span><span style=\\"color:#000000FF\\">).</span><span style=\\"color:#795E26\\">html</span><span style=\\"color:#000000FF\\">(</span><span style=\\"color:#A31515\\">'&lt;p&gt;接收：'</span><span style=\\"color:#000000\\">+</span><span style=\\"color:#001080\\">evt</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#001080\\">data</span><span style=\\"color:#000000\\">+</span><span style=\\"color:#A31515\\">'&lt;/p&gt;'</span><span style=\\"color:#000000FF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"color:#000000FF\\">            };</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">            ws</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#795E26\\">onclose</span><span style=\\"color:#000000\\"> =</span><span style=\\"color:#0000FF\\"> function</span><span style=\\"color:#000000FF\\"> () {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">                console</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#795E26\\">log</span><span style=\\"color:#000000FF\\">(</span><span style=\\"color:#A31515\\">'WebSocket连接已断开'</span><span style=\\"color:#000000FF\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"color:#000000FF\\">            };</span></span>\\n<span class=\\"line\\"><span style=\\"color:#000000FF\\">        } </span><span style=\\"color:#AF00DB\\">else</span><span style=\\"color:#000000FF\\"> {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#008000\\">            // 浏览器不支持 WebSocket</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">            console</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#795E26\\">log</span><span style=\\"color:#000000FF\\">(</span><span style=\\"color:#A31515\\">'您的浏览器不支持 WebSocket!'</span><span style=\\"color:#000000FF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"color:#000000FF\\">        }</span></span>\\n<span class=\\"line\\"><span style=\\"color:#000000FF\\">    }</span></span>\\n<span class=\\"line\\"><span style=\\"color:#0000FF\\">function</span><span style=\\"color:#795E26\\"> send</span><span style=\\"color:#000000FF\\">(){</span></span>\\n<span class=\\"line\\"><span style=\\"color:#001080\\">        ws</span><span style=\\"color:#000000FF\\">.</span><span style=\\"color:#795E26\\">send</span><span style=\\"color:#000000FF\\">(</span><span style=\\"color:#A31515\\">\\"发送一条消息\\"</span><span style=\\"color:#000000FF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"color:#000000FF\\">    }</span><span style=\\"color:#800000\\">&lt;/script&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;/body&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#800000\\">&lt;/html&gt;</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"></span></code></pre><div class=\\"line-numbers\\" aria-hidden=\\"true\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}`);export{k as comp,f as data};
